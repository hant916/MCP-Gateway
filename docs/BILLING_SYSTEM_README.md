# ğŸ’° MCP Gateway è®¡è´¹ç³»ç»Ÿ

MCP Gatewayçš„Pay-for-Usageè®¡è´¹ç³»ç»Ÿï¼Œæä¾›å®æ—¶ä½¿ç”¨é‡è·Ÿè¸ªå’Œè´¹ç”¨è®¡ç®—ã€‚

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶

- **UsageRecord**: ä½¿ç”¨è®°å½•å®ä½“ï¼Œè®°å½•æ¯æ¬¡APIè°ƒç”¨è¯¦æƒ…
- **BillingRule**: è®¡è´¹è§„åˆ™é…ç½®ï¼Œæ”¯æŒå¤šç§è®¡è´¹æ¨¡å¼
- **UsageBillingService**: æ ¸å¿ƒè®¡è´¹æœåŠ¡ï¼Œå¤„ç†ä½¿ç”¨é‡è®°å½•å’Œè´¹ç”¨è®¡ç®—
- **BillingController**: REST APIæ§åˆ¶å™¨ï¼Œæä¾›æŸ¥è¯¢å’Œç»Ÿè®¡æ¥å£

## âœ¨ ä¸»è¦åŠŸèƒ½

### ğŸ”„ è‡ªåŠ¨ä½¿ç”¨é‡è·Ÿè¸ª
- **å®æ—¶è®°å½•**: è‡ªåŠ¨è®°å½•æ‰€æœ‰APIè°ƒç”¨
- **å¼‚æ­¥å¤„ç†**: ä¸å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½
- **å®Œæ•´ä¿¡æ¯**: è®°å½•æ—¶é—´ã€ç«¯ç‚¹ã€çŠ¶æ€ç ã€å¤„ç†æ—¶é—´ç­‰
- **é˜²é‡å¤**: æ£€æµ‹å¹¶è­¦å‘Šé‡å¤è®¡è´¹è®°å½•

### ğŸ’³ çµæ´»è®¡è´¹è§„åˆ™
- **å¤šç§æ¨¡å¼**: æŒ‰æ¬¡æ•°ã€æ•°æ®é‡ã€æ—¶é—´ã€ç»„åˆè®¡è´¹
- **é€šé…ç¬¦åŒ¹é…**: APIæ¨¡å¼æ”¯æŒ`*`é€šé…ç¬¦
- **ä¼˜å…ˆçº§ç³»ç»Ÿ**: é«˜ä¼˜å…ˆçº§è§„åˆ™ä¼˜å…ˆåŒ¹é…
- **å¤±è´¥è°ƒç”¨**: å¯é…ç½®æ˜¯å¦å¯¹å¤±è´¥è°ƒç”¨è®¡è´¹

### ğŸ“Š ç»Ÿè®¡åˆ†æ
- **æ—¶é—´èŒƒå›´æŸ¥è¯¢**: æ”¯æŒæŒ‰æ—¶é—´æ®µæŸ¥è¯¢ä½¿ç”¨è®°å½•
- **å¤šç»´åº¦ç»Ÿè®¡**: æŒ‰ç”¨æˆ·ã€ä¼šè¯ã€APIç«¯ç‚¹ã€çŠ¶æ€ç­‰ç»´åº¦ç»Ÿè®¡
- **æˆæœ¬åˆ†æ**: æ€»è´¹ç”¨ã€å¹³å‡è´¹ç”¨ã€æŒ‰æ—¶é—´åˆ†å¸ƒç­‰
- **å®æ—¶æŸ¥è¯¢**: è·å–å½“å‰ç´¯è®¡è´¹ç”¨

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### UsageRecord (ä½¿ç”¨è®°å½•)
```java
- id: UUID (ä¸»é”®)
- sessionId: UUID (ä¼šè¯ID)  
- userId: UUID (ç”¨æˆ·ID)
- timestamp: Timestamp (è°ƒç”¨æ—¶é—´)
- apiEndpoint: String (APIç«¯ç‚¹)
- httpMethod: String (HTTPæ–¹æ³•)
- statusCode: Integer (å“åº”çŠ¶æ€ç )
- requestSize: Long (è¯·æ±‚å¤§å°,å­—èŠ‚)
- responseSize: Long (å“åº”å¤§å°,å­—èŠ‚)
- processingMs: Integer (å¤„ç†æ—¶é—´,æ¯«ç§’)
- costAmount: BigDecimal (è´¹ç”¨é‡‘é¢)
- messageType: String (æ¶ˆæ¯ç±»å‹)
- billingStatus: Enum (è®¡è´¹çŠ¶æ€)
```

### BillingRule (è®¡è´¹è§„åˆ™)
```java
- id: UUID (ä¸»é”®)
- ruleName: String (è§„åˆ™åç§°)
- apiPattern: String (APIè·¯å¾„æ¨¡å¼,æ”¯æŒé€šé…ç¬¦)
- httpMethod: String (HTTPæ–¹æ³•,å¯é€‰)
- costPerCall: BigDecimal (æ¯æ¬¡è°ƒç”¨è´¹ç”¨)
- costPerKb: BigDecimal (æ¯KBæ•°æ®è´¹ç”¨)
- costPerSecond: BigDecimal (æ¯ç§’å¤„ç†æ—¶é—´è´¹ç”¨)
- ruleType: Enum (è®¡è´¹ç±»å‹)
- priority: Integer (ä¼˜å…ˆçº§)
- isActive: Boolean (æ˜¯å¦æ¿€æ´»)
```

## ğŸš€ REST APIæ¥å£

### æ ¸å¿ƒç«¯ç‚¹
```bash
# å¥åº·æ£€æŸ¥
GET /api/v1/billing/health

# è·å–å½“å‰è´¹ç”¨
GET /api/v1/billing/cost/current?userId={userId}

# æŸ¥è¯¢ä½¿ç”¨è®°å½•
GET /api/v1/billing/usage?userId={userId}&startTime=2024-01-01T00:00:00Z&endTime=2024-12-31T23:59:59Z&page=0&size=20

# è·å–ä¼šè¯ä½¿ç”¨è®°å½•
GET /api/v1/billing/usage/session/{sessionId}

# ä½¿ç”¨é‡æ‘˜è¦
GET /api/v1/billing/usage/summary?userId={userId}&startTime=2024-01-01T00:00:00Z&endTime=2024-12-31T23:59:59Z

# æµ‹è¯•è®°å½•ä½¿ç”¨é‡
POST /api/v1/billing/test/record?sessionId={sessionId}&apiEndpoint=/api/v1/test&httpMethod=POST&statusCode=200
```

## âš™ï¸ é»˜è®¤è®¡è´¹è§„åˆ™

| APIæ¨¡å¼ | è´¹ç”¨ | æè¿° |
|---------|------|------|
| `/api/v1/sse/message` | $0.001/æ¬¡ | SSEæ¶ˆæ¯å‘é€ |
| `/api/v1/mcp-server/*/sessions` | $0.005/æ¬¡ | ä¼šè¯åˆ›å»º |
| `/api/v1/sessions/*/sse` | $0.002/æ¬¡ | SSEè¿æ¥å»ºç«‹ |
| `/api/v1/sessions/*/streamable-http` | $0.003/æ¬¡ | æµå¼HTTPè¯·æ±‚ |
| `*` | $0.001/æ¬¡ | é»˜è®¤è§„åˆ™(å…œåº•) |

## ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡ç¤ºä¾‹

### å½“å‰è´¹ç”¨æŸ¥è¯¢
```json
{
    "userId": "123e4567-e89b-12d3-a456-426614174000",
    "currentCost": 0.0150,
    "currency": "USD",
    "timestamp": "2024-01-15T10:30:00Z"
}
```

### ä½¿ç”¨é‡æ‘˜è¦
```json
{
    "userId": "123e4567-e89b-12d3-a456-426614174000",
    "totalCalls": 45,
    "totalCost": 0.0510,
    "periodStart": "2024-01-01T00:00:00Z",
    "periodEnd": "2024-01-15T23:59:59Z",
    "apiEndpointStats": [
        {
            "endpoint": "/api/v1/sse/message",
            "calls": 30,
            "cost": 0.030
        }
    ],
    "dailyStats": [
        {
            "date": "2024-01-15",
            "calls": 15,
            "cost": 0.015
        }
    ]
}
```

## ğŸ”§ é›†æˆé…ç½®

### è‡ªåŠ¨é›†æˆ
è®¡è´¹ç³»ç»Ÿå·²è‡ªåŠ¨é›†æˆåˆ°`SessionService`ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

```java
@Service
public class SessionService {
    @Autowired
    private UsageBillingService billingService;
    
    // è‡ªåŠ¨è®°å½•ä½¿ç”¨é‡
    public void recordApiUsage(UUID sessionId, String endpoint, int statusCode) {
        billingService.recordUsageAsync(sessionId, endpoint, "GET", statusCode, 
            System.currentTimeMillis(), null, null, 100);
    }
}
```

### è‡ªå®šä¹‰è®¡è´¹è§„åˆ™
å¯é€šè¿‡æ•°æ®åº“ç›´æ¥æ·»åŠ è‡ªå®šä¹‰è®¡è´¹è§„åˆ™ï¼š

```sql
INSERT INTO billing_rules (id, rule_name, api_pattern, cost_per_call, description, priority, is_active) 
VALUES (gen_random_uuid(), 'Custom API Rule', '/api/v1/custom/*', 0.01, 'è‡ªå®šä¹‰APIè®¡è´¹', 10, true);
```

## ğŸ”’ å®‰å…¨ä¸æ€§èƒ½

### æ•°æ®ä¿æŠ¤
- **å¤–é”®çº¦æŸ**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§
- **çº§è”åˆ é™¤**: ç”¨æˆ·/ä¼šè¯åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³è®°å½•
- **æ•æ„Ÿä¿¡æ¯è„±æ•**: å¯¹Authorizationç­‰æ•æ„Ÿä¿¡æ¯è¿›è¡Œå¤„ç†

### æ€§èƒ½ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨@Asyncæ³¨è§£ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡
- **ç´¢å¼•ä¼˜åŒ–**: é’ˆå¯¹å¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡è®°å½•å’ŒæŸ¥è¯¢

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **è®¡è´¹è§„åˆ™ä¸åŒ¹é…**: æ£€æŸ¥`api_pattern`å’Œ`is_active`çŠ¶æ€
2. **é‡å¤è®¡è´¹è­¦å‘Š**: æ­£å¸¸è­¦å‘Šï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡è¯•é€»è¾‘
3. **è´¹ç”¨è®¡ç®—é”™è¯¯**: æ£€æŸ¥å¯¹åº”çš„è®¡è´¹è§„åˆ™é…ç½®

### æ—¥å¿—çº§åˆ«
- **INFO**: è®°å½•ä½¿ç”¨é‡è®°å½•çš„åŸºæœ¬ä¿¡æ¯
- **DEBUG**: è¯¦ç»†çš„è®¡è´¹è§„åˆ™åŒ¹é…å’Œè´¹ç”¨è®¡ç®—è¿‡ç¨‹
- **WARN**: é‡å¤è®°å½•ã€è§„åˆ™åŒ¹é…å¤±è´¥ç­‰è­¦å‘Š

## ğŸ”„ æ‰©å±•æ€§

### å¾®æœåŠ¡åŒ–å‡†å¤‡
- **ç‹¬ç«‹æœåŠ¡**: è®¡è´¹é€»è¾‘å·²ç‹¬ç«‹å°è£…ï¼Œæ˜“äºæ‹†åˆ†
- **APIæ ‡å‡†åŒ–**: REST APIéµå¾ªæ ‡å‡†è§„èŒƒ
- **æ•°æ®åº“ç‹¬ç«‹**: è®¡è´¹ç›¸å…³è¡¨å¯ç‹¬ç«‹éƒ¨ç½²

### åŠŸèƒ½æ‰©å±•
- **å®æ—¶è®¡è´¹**: å½“å‰æ”¯æŒå¼‚æ­¥è®¡è´¹ï¼Œå¯æ‰©å±•ä¸ºå®æ—¶è®¡è´¹
- **é…é¢ç®¡ç†**: å¯æ‰©å±•ç”¨æˆ·é…é¢å’Œé™æµåŠŸèƒ½
- **è´¦å•ç”Ÿæˆ**: å¯æ‰©å±•å®šæœŸè´¦å•ç”Ÿæˆå’Œå‘é€åŠŸèƒ½

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v2.0.0* 